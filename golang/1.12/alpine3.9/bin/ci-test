#!/bin/bash

set -e

usage() {
    echo "usage: ci-test [--out test.xml] [--cover coverage.xml] [--html coverage.html] go-pkg"
}

while [[ "$1" == -* ]]; do
    case $1 in
        -o|--out)
            shift
            OUTFILE=$1
            shift
            ;;
        -c|--cover)
            shift
            COVERFILE=$1
            shift
            ;;
        -h|--html)
            shift
            HTMLFILE=$1
            shift
            ;;
        *)
            usage
            exit 1
    esac
done

if [ -z "$OUTFILE" ]; then
    OUTFILE=test.xml
fi

if [ -z "$COVERFILE" ]; then
    COVERFILE=coverage.xml
fi

if [ -z "$HTMLFILE" ]; then
    HTMLFILE=coverage.html
fi

if [ "$#" -eq 0 ]; then
    PKG=./...
else
    PKG=${@:1}
fi

set +e

gotestsum --junitfile $OUTFILE -- -coverprofile=${COVERFILE}.out $PKG
code=$?
gocover-cobertura < ${COVERFILE}.out > $COVERFILE
go tool cover -html=${COVERFILE}.out -o $HTMLFILE
rm ${COVERFILE}.out
exit $code
